{% extends 'admin_custom/base.html' %}

{% block title %}{{ page_title }} - HamsukyPay Admin{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block page_subtitle %}Merchant details and related information{% endblock %}

{% block styles %}
<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 500;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        border-radius: 0.25rem;
    }
    
    .status-badge-success {
        color: #0e6c4a;
        background-color: #d0f1e3;
    }
    
    .status-badge-danger {
        color: #991b1b;
        background-color: #fee2e2;
    }
    
    .status-badge-warning {
        color: #92400e;
        background-color: #fef3c7;
    }
    
    .status-badge-secondary {
        color: #5a5a5a;
        background-color: #e9e9e9;
    }
    
    .detail-section {
        margin-bottom: 2rem;
    }
    
    .detail-card {
        height: 100%;
    }
    
    .merchant-metadata-table th {
        width: 40%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Action Buttons -->
<div class="action-buttons mb-4">
    <a href="{% url 'payments:admin_merchants' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i> Back to Merchants
    </a>
    <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#emailMerchantModal">
        <i class="fas fa-envelope me-2"></i> Email Merchant
    </button>
    {% if merchant.verification_status == 'pending' %}
    <button type="button" class="btn btn-success ms-2" onclick="updateVerificationStatus('{{ merchant.id }}', 'verified')">
        <i class="fas fa-check-circle me-2"></i> Approve Verification
    </button>
    <button type="button" class="btn btn-danger ms-2" onclick="updateVerificationStatus('{{ merchant.id }}', 'rejected')">
        <i class="fas fa-times-circle me-2"></i> Reject Verification
    </button>
    {% endif %}
</div>

<div class="row">
    <!-- Main Merchant Information -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">Business Information</h6>
                <div class="card-header-actions">
                    {% if merchant.verification_status == 'verified' %}
                        <span class="status-badge status-badge-success">Verified</span>
                    {% elif merchant.verification_status == 'pending' %}
                        <span class="status-badge status-badge-warning">Pending Verification</span>
                    {% elif merchant.verification_status == 'rejected' %}
                        <span class="status-badge status-badge-danger">Verification Rejected</span>
                    {% else %}
                        <span class="status-badge status-badge-secondary">Unverified</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Business Name</h6>
                        <p class="fw-medium fs-5">{{ merchant.business_name }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Business Email</h6>
                        <p class="fw-medium">{{ merchant.business_email }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Business Phone</h6>
                        <p class="fw-medium">{{ merchant.business_phone }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Industry</h6>
                        <p class="fw-medium">{{ merchant.industry|default:"Not specified" }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Website</h6>
                        <p class="fw-medium">
                            {% if merchant.website %}
                                <a href="{{ merchant.website }}" target="_blank">{{ merchant.website }}</a>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Account Created</h6>
                        <p class="fw-medium">{{ merchant.created_at|date:"M d, Y" }}</p>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row">
                    <div class="col-12 mb-4">
                        <h6 class="text-muted mb-1">Business Address</h6>
                        <p class="fw-medium">{{ merchant.business_address|default:"Not specified" }}</p>
                    </div>
                    <div class="col-12 mb-4">
                        <h6 class="text-muted mb-1">Business Description</h6>
                        <p class="fw-medium">{{ merchant.business_description|default:"Not specified" }}</p>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Settlement Bank</h6>
                        <p class="fw-medium">{{ merchant.settlement_bank|default:"Not specified" }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Settlement Account</h6>
                        <p class="fw-medium">{{ merchant.settlement_account|default:"Not specified" }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Account Holder Name</h6>
                        <p class="fw-medium">{{ merchant.settlement_account_name|default:"Not specified" }}</p>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Transaction Fee</h6>
                        <p class="fw-medium">{{ merchant.transaction_fee_percentage }}%</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">API Credentials</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Public Key</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" value="{{ merchant.public_key }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ merchant.public_key }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h6 class="text-muted mb-1">Secret Key</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" value="sk_****{{ merchant.secret_key|slice:'-4:' }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#secretKeyModal">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">Recent Transactions</h6>
                <div class="card-header-actions">
                    <a href="{% url 'payments:admin_transactions' %}?merchant={{ merchant.id }}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>
                                    <a href="{% url 'payments:admin_transaction_detail' transaction.reference %}" class="text-decoration-none">
                                        {{ transaction.reference }}
                                    </a>
                                </td>
                                <td>{{ transaction.email }}</td>
                                <td>{{ transaction.currency }} {{ transaction.amount|floatformat:2 }}</td>
                                <td>
                                    {% if transaction.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                    {% elif transaction.status == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% elif transaction.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% elif transaction.status == 'refunded' %}
                                        <span class="badge bg-info">Refunded</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ transaction.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <p class="text-muted mb-0">No transactions found for this merchant</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Sidebar Cards -->
    <div class="col-lg-4">
        <!-- Merchant Account Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">Account Owner</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Name</h6>
                    <p class="fw-medium">{{ merchant.user.first_name }} {{ merchant.user.last_name }}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Email</h6>
                    <p class="fw-medium">{{ merchant.user.email }}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Username</h6>
                    <p class="fw-medium">{{ merchant.user.username }}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Last Login</h6>
                    <p class="fw-medium">
                        {% if merchant.user.last_login %}
                            {{ merchant.user.last_login|date:"M d, Y H:i" }}
                        {% else %}
                            <span class="text-muted">Never logged in</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">Statistics</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Total Transactions</h6>
                    <p class="fw-medium fs-4">{{ stats.total_transactions }}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Successful Transactions</h6>
                    <p class="fw-medium fs-4">{{ stats.successful_transactions }}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted mb-1">Transaction Volume</h6>
                    <p class="fw-medium fs-4">₦{{ stats.transaction_volume|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        
        <!-- Transaction Trend Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">7-Day Transaction Trend</h6>
            </div>
            <div class="card-body">
                <canvas id="transactionTrendChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-header-title">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#emailMerchantModal">
                        <i class="fas fa-envelope me-2"></i> Send Email
                    </button>
                    
                    <a href="#" class="btn btn-outline-secondary" onclick="resetApiKeys('{{ merchant.id }}')">
                        <i class="fas fa-sync-alt me-2"></i> Reset API Keys
                    </a>
                    
                    {% if merchant.is_active %}
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#suspendModal">
                        <i class="fas fa-ban me-2"></i> Suspend Account
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-outline-success" onclick="activateAccount('{{ merchant.id }}')">
                        <i class="fas fa-check-circle me-2"></i> Activate Account
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Merchant Modal -->
<div class="modal fade" id="emailMerchantModal" tabindex="-1" aria-labelledby="emailMerchantModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailMerchantModalLabel">Send Email to {{ merchant.business_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'payments:admin_send_merchant_email' merchant.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="emailRecipient" class="form-label">Recipient</label>
                        <input type="email" class="form-control" id="emailRecipient" value="{{ merchant.business_email }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="emailSubject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="emailMessage" name="message" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Email</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Secret Key Modal -->
<div class="modal fade" id="secretKeyModal" tabindex="-1" aria-labelledby="secretKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="secretKeyModalLabel">Secret API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Secret Key for {{ merchant.business_name }}</label>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This is a sensitive credential. Only view and share when absolutely necessary.
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="fullSecretKey" value="{{ merchant.secret_key }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ merchant.secret_key }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Suspend Account Modal -->
<div class="modal fade" id="suspendModal" tabindex="-1" aria-labelledby="suspendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suspendModalLabel">Suspend Merchant Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to suspend this merchant account? This will prevent them from processing payments.</p>
                <form id="suspendForm">
                    <div class="mb-3">
                        <label for="suspendReason" class="form-label">Suspension Reason</label>
                        <select class="form-select" id="suspendReason" required>
                            <option value="">Select Reason</option>
                            <option value="compliance_issue">Compliance Issue</option>
                            <option value="suspicious_activity">Suspicious Activity</option>
                            <option value="payment_issues">Payment Issues</option>
                            <option value="merchant_request">Merchant Request</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="suspendComment" class="form-label">Additional Comment</label>
                        <textarea class="form-control" id="suspendComment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="suspendAccount('{{ merchant.id }}')">Suspend Account</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Transaction trend chart
        const ctx = document.getElementById('transactionTrendChart').getContext('2d');
        const transactionTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ trend.labels|safe }},
                datasets: [{
                    label: 'Transactions',
                    data: {{ trend.data|safe }},
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    });
    
    // Copy to clipboard function
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        alert('Copied to clipboard!');
    }
    
    // Function to update verification status
    function updateVerificationStatus(merchantId, status) {
        if (confirm(`Are you sure you want to change verification status to ${status}?`)) {
            // In a real implementation, you'd use fetch or axios to call your backend
            // Here's a simple way to submit this via a form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin-custom/merchants/${merchantId}/update-verification/`;
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Add status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = status;
            form.appendChild(statusInput);
            
            // If it's rejected, ask for a reason
            if (status === 'rejected') {
                const reason = prompt('Please provide a reason for rejection:');
                if (reason !== null) {
                    const reasonInput = document.createElement('input');
                    reasonInput.type = 'hidden';
                    reasonInput.name = 'reason';
                    reasonInput.value = reason;
                    form.appendChild(reasonInput);
                } else {
                    return; // User cancelled the prompt
                }
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Function to reset API keys
    function resetApiKeys(merchantId) {
        if (confirm('Are you sure you want to reset this merchant\'s API keys? This will invalidate their current keys.')) {
            alert('API keys would be reset here. In a real implementation, you would make an API call to reset the keys.');
        }
    }
    
    // Function to suspend account
    function suspendAccount(merchantId) {
        const reason = document.getElementById('suspendReason').value;
        const comment = document.getElementById('suspendComment').value;
        
        if (!reason) {
            alert('Please select a suspension reason');
            return;
        }
        
        alert('Account would be suspended here. In a real implementation, you would make an API call to suspend the account.');
        window.location.reload();
    }
    
    // Function to activate account
    function activateAccount(merchantId) {
        if (confirm('Are you sure you want to activate this merchant account?')) {
            alert('Account would be activated here. In a real implementation, you would make an API call to activate the account.');
            window.location.reload();
        }
    }
</script>
{% endblock %}